# Batch Running MaxFilter remotly with ssh give list of file names 
# Files can be defined in one of two ways
#		1. 	Files in FILE_LIST are in the folder SERVER_PATH
#		2. 	Files in FILE_LIST are in subfolders beneath SERVER_PATH, but these
#			subfolders coded within the FILE_LIST name. That is:
#			nc01s01r* --> SERVER_PATH/NC01/S01/nc01s01r* 
# 
# Will take data from server and put *_sss, *_sss_trans, *_tsss, *_tsss_trans data back on the server
# Takes like ~10 minutes each file
#
# Will take bad channel list files from server
# Make sure your bad channels list is on the server in the right place (see matlab)
#
# Must ssh in to Gus's old computer 
# 	Open Terminal
#	ssh gsudre@192.168.1.151
#	enter password (takes a few minutes before it asks, will sometime time out)
# 
# POSSIBLE ERROR: "Writing of the raw data tag failed!"
#	SOLUTION: memory full, delete crap
#
# 2013-02-21 Stephen Foldes
# UPDATES:
# 2013-02-22 Foldes: Small name change
# 2013-03-26 Foldes: Fixed issue with different lengths of subject names.
# 2014-02-13 Foldes: Added option for non-formated subfolders (i.e. just plain)

# ===USER INPUT===
	# Path to the data on the server, before subject
	#export SERVER_PATH=/mnt/Katz/experiments/meg_neurofeedback/
	export SERVER_PATH=/mnt/Katz/experiments/meg_neurofeedback/Test/Stimulation
	#export SERVER_PATH=/mnt/Katz/experiments/ecog_dbi/DBI05/MEG/
	
		# export FILE_LIST='nc01s01r06 ns08s01r07'
	export FILE_LIST='dbi05s01r03 dbi05s01r04 dbi05s01r05 dbi05s01r06 dbi05s01r07 dbi05s01r08 dbi05s01r09 dbi05s01r10 dbi05s01r11 dbi05s01r12 dbi05s01r13 dbi05s01r14 dbi05s01r15 dbi05s01r16'
	export FILE_LIST='mr01 mr02 mr03 mr04 mr05 mr06 mr07 mr08 mr09'

	# Number of characters for the subject ID
	# Neurofeedback = 4, Presurgical = 5
	export NUM_SUBJECT_CHAR=5


	# Default local-temporary storage
	export TEMP_STORAGE_PATH=/mnt/D/SSS/

# ================


for ifile in $FILE_LIST
do

	# ---AUTO GENERATE FILE INFO--
	export SUBJECT_ID="$(echo ${ifile[@]:0:${NUM_SUBJECT_CHAR}} | tr '[:lower:]' '[:upper:]')"
	export SESSION_NUM=${ifile[@]:$((NUM_SUBJECT_CHAR + 1)):2}
	export FULL_FIF_PATH=${SERVER_PATH}${SUBJECT_ID}/S${SESSION_NUM}/${ifile}.fif
	echo 'Processing: ' $FULL_FIF_PATH

	# ---RUN MAXFILTER---
	/usr/local/MaxFilter_Run_Code/MaxFilter_FOLDES_single_file_SERVERSAVE.sh $FULL_FIF_PATH $TEMP_STORAGE_PATH
done


#===========================================================
#===SERVER_PATH IS THE EXACT PATH, DONT DO ANYTHING FANCY===
#===========================================================

for ifile in $FILE_LIST
do
	# ---AUTO GENERATE FILE INFO--
	export FULL_FIF_PATH=${SERVER_PATH}/${ifile}.fif
	echo 'Processing: ' $FULL_FIF_PATH

	# ---RUN MAXFILTER---
	/usr/local/MaxFilter_Run_Code/MaxFilter_FOLDES_single_file_SERVERSAVE.sh $FULL_FIF_PATH $TEMP_STORAGE_PATH
done


















